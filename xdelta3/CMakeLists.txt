cmake_minimum_required(VERSION 3.13)

project(xdelta3)

add_library(xdelta
  xdelta3-blkcache.h
  xdelta3-decode.h
  xdelta3-djw.h
  xdelta3-fgk.h
  xdelta3-hash.h
  xdelta3-internal.h
  xdelta3-list.h
  xdelta3-lzma.h
  xdelta3-main.h
  xdelta3-merge.h
  xdelta3-second.h
  xdelta3-test.h
  xdelta3-cfgs.h
  xdelta3.h
  xdelta3.c
)

target_include_directories(xdelta PUBLIC ${PROJECT_SOURCE_DIR})

target_link_libraries(xdelta)

# TODO: AX_CHECK_ALIGNED_ACCESS_REQUIRED
# TODO: lzma

include(CheckTypeSize)

function(config_definition def value)
  if(${WRITTEN_CONFIG})
  else()
    file(WRITE config.h "// Autogenerated by cmake\n")
    set(WRITTEN_CONFIG ON PARENT_SCOPE)
  endif()
  file(APPEND config.h "#define ${def} ${value} \n")
endfunction()

function(config_type_size type def)
  check_type_size("${type}" SIZE)
  if(${WRITTEN_CONFIG})
    set(WRITTEN_CONFIG ON)
  endif()
  config_definition("${def}" "${SIZE}")
  set(WRITTEN_CONFIG ON PARENT_SCOPE)
endfunction()

config_type_size(size_t SIZEOF_SIZE_T)
config_type_size("unsigned int" SIZEOF_UNSIGNED_INT)
config_type_size("unsigned long" SIZEOF_UNSIGNED_LONG)
config_type_size("unsigned long long" SIZEOF_UNSIGNED_LONG_LONG)
config_definition(SECONDARY_DJW 1)
config_definition(SECONDARY_FGK 1)
config_definition(XD3_ENCODER 1)
config_definition(NOT_MAIN 1)
